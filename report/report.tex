\documentclass[a4paper, 10pt]{article}

\usepackage{titlesec}
% Riduci drasticamente lo spazio sopra e sotto i titoli
\titlespacing*{\section}{0pt}{6pt plus 2pt minus 2pt}{4pt plus 2pt minus 2pt}
\titlespacing*{\subsection}{0pt}{4pt plus 2pt minus 2pt}{2pt plus 2pt minus 2pt}
\titlespacing*{\subsubsection}{0pt}{3pt plus 2pt minus 2pt}{1pt plus 2pt minus 2pt}
% --- IMPOSTAZIONI DI PAGINA (CRUCIALE PER LE 6 PAGINE) ---
% Margini ridotti a 2cm per guadagnare spazio vitale
\usepackage[left=2cm, right=2cm, top=2cm, bottom=2cm]{geometry}

% --- LINGUA E CODIFICA ---
\usepackage[utf8]{inputenc}
\usepackage[T1]{fontenc}
\usepackage[italian]{babel}     % Traduce "Figure", "Table", ecc.
\usepackage{microtype}          % Migliora la spaziatura e la sillabazione (aspetto più professionale)

% --- MATEMATICA E TABELLE ---
\usepackage{amsmath, amssymb}   % Simboli matematici
\usepackage{booktabs}           % Per tabelle professionali (senza linee verticali)
\usepackage{array}

% --- GRAFICI E IMMAGINI ---
\usepackage{graphicx}
\usepackage{subcaption}         % Fondamentale per mettere grafici affiancati (Fig 1a, 1b)
\usepackage{float} 				   % Per usare [H] e bloccare le immagini dove vuoi tu
\usepackage{wrapfig}          
\usepackage[colorlinks=true,      % Attiva i colori invece dei riquadri
linkcolor=black,      % Colore link interni (es. Indice, Figure) - meglio black per stampare
urlcolor=blue,        % Colore link web (es. il tuo dataset)
citecolor=black       % Colore citazioni bibliografiche
]{hyperref}% Per link cliccabili (es. fonte dataset) senza rettangoli rossi

% --- CONFIGURAZIONE CODICE R (PER APPENDICE) ---
\usepackage{listings}
\usepackage{xcolor}
\usepackage{lmodern}
\usepackage{enumitem}
\usepackage{placeins}


\definecolor{codegreen}{rgb}{0,0.6,0}
\definecolor{codegray}{rgb}{0.5,0.5,0.5}
\definecolor{codepurple}{rgb}{0.58,0,0.82}
\definecolor{backcolour}{rgb}{0.95,0.95,0.92}

\lstset{ 
	language=R,
	alsoletter={.,_},
	backgroundcolor=\color{backcolour},   
	commentstyle=\color{codegreen},
	keywordstyle=\color{blue},
	numberstyle=\tiny\color{codegray},
	stringstyle=\color{codepurple},
	basicstyle=\footnotesize\ttfamily, % Font piccolo monospaziato
	breakatwhitespace=false,         
	breaklines=true,                 % Va a capo se la riga è troppo lunga
	captionpos=b,                    
	keepspaces=true,                 
	numbers=left,                    % Numeri di riga a sinistra
	numbersep=5pt,                  
	showspaces=false,                
	showstringspaces=false,
	showtabs=false,                  
	tabsize=2,
	frame=single      
	}

% --- INIZIO DEL DOCUMENTO ---
\begin{document}
	
	% --- INTESTAZIONE COMPATTA (Custom Header) ---
	% Non uso \maketitle standard perché occupa mezza pagina inutile.
	\begin{center}
		% Nome del gruppo (evocativo come richiesto)
		{\Large \textbf{GRUPPO: CORES}} \\ 
		\vspace{0.2cm}
		% Titolo del corso e Report
		{\large \textsc{Statistica computazionale -- Report Finale}} \\
		\vspace{0.1cm}
		% Membri del gruppo
		\small
		\begin{tabular}{c c c}
			Maccianti Federico & Rapacioli Nicola & Riva Pietro \\
			(909656) & (915439) & (908813) 
		\end{tabular}
	\end{center}
	
	\hrule
	\vspace{0.5cm}
	
	
	\section{Introduzione}
	Il seguente studio, si pone come obiettivo quello di individuare i diversi stili di guida presenti nella Formula 1, tramite l'analisi dei dati di telemetria (\href{https://github.com/TracingInsights/2025.git}{TracingInsights}\footnote{Codice di estrazione dati nell'appendice \ref{estrazione}.}) di ciascun pilota.
	Lo studio si concentra sui dati relativi alle sessioni di qualifica della stagione di Formula 1 2025, selezionando per ciascun pilota il singolo giro migliore.\\
	
	
	Il dataset originale include le seguenti variabili:
	\begin{center}
		\begin{tabular}{llll}
			\hline
			\textbf{Variabile} & \textbf{Unità di misura} & \textbf{Supporto} & \textbf{Tipo} \\
			\hline
			Gran premio & -- & $\{\text{Nomi GP}\}$  & \texttt{character} \\
			Pilota & --   & $\{\text{Sigle Piloti}\}$  & \texttt{character} \\
			Tempo dal via  & $\mathrm{s}$  & $\mathbb{R^+}$  & \texttt{numeric} \\
			Distanza percorsa  & $\mathrm{m}$ & $\mathbb{R^+}$  & \texttt{numeric} \\
			Distanza relativa  & --  & $[0, 1]$    & \texttt{numeric} \\
			Velocità  & $\mathrm{km/h}$  &  $\mathbb{N}$   & \texttt{numeric} \\
			Regime motore & RPM   & $\mathbb{N}$  & \texttt{numeric} \\
			Marcia    & --   & $\{1, \dots, 8\}$  & \texttt{integer} \\
			Freno     & --    & $\{0, 1\}$   & \texttt{factor} \\
			Acceleratore  & $\%$   & $[0, 100]$    & \texttt{numeric} \\
			DRS  & --     & $\{0, 1\}$     & \texttt{factor} \\
			Accelerazione laterale e longitudinale    & $\mathrm{g}$ &$\mathbb{R}$ & \texttt{numeric} \\
			Coordinate spaziali x,y,z  & $\mathrm{m}$   & $\mathbb{R}$     & \texttt{numeric} \\
			Tempo Giro       &$\mathrm{s}$  & $\mathbb{R^+}$ &\texttt{numeric}\\
			
								
			\hline
		\end{tabular}
	\end{center}
	
	Il dataset presenta le seguenti codifiche: le feature binarie assumono valore $0$ in assenza dell'evento e $1$ in sua presenza. La telemetria dell'acceleratore misura l'intensità dell'input del pilota, mentre per le distanze indicano la posizione progressiva rispetto allo start.
	
	\section{Analisi Esplorativa}
	\subsection{Considerazioni sulle variabili}
		
	Poiché lo stile di guida non è riconducibile a variabili di tipo posizionale, le coordinate spaziali e le misure di distanza, sia assolute che relative, vengono escluse dall’analisi.
	
	
	In questa fase preliminare, lo stile di guida viene descritto attraverso variabili dinamiche, quali l’utilizzo dell’acceleratore, del freno, la velocità e le seguenti accelerazioni longitudinali e laterali, che consentono, per esempio, di valutare rispettivamente le modalità di decelerazione in ingresso curva, l’intensità con cui la curva viene affrontata tutte caratteristiche che fanno riferimento allo stile di guida.
	A sostegno delle ipotesi sopra citate, si riporta la Figura \ref{fig:confronto} che confronta nel Gran Premio degli USA le accelerazioni e velocità per i piloti: Charles Leclerc, Lando Norris, Max Verstappen e Franco Colapinto.\begin{figure}[H]
		\centering
		\includegraphics[width=.65\textwidth]{tel_ex1.pdf}
		\caption{Accelerazioni VER, LEC, NOR, COL.}
		\label{fig:confronto}
	\end{figure}
	Si nota infatti come nelle variazioni repentine si possano già individuare differenze significative tra piloti.
	
	
	Dalle prime analisi descrittive sul dataset\footnote{Estratto codice R consultabile nell'appendice \ref{codice preliminare}.\label{appendice 2}}, viene osservato come per il pilota Russell al Gran Premio di Miami siano presenti degli \texttt{NA} nella variabile \texttt{distanza relativa}. Osservando i dati grezzi si può notare come ciò sia riconducibile al malfunzionamento  dei sensori telemetrici - presenza di molti zeri in molte variabili e accelerazioni costanti durante l'intero giro. Per i motivi elencati sopra, si procede dunque ad eliminare i record.
	
	\begin{wrapfigure}{r}{0.5 \textwidth }
		\includegraphics[width=.4\textwidth]{tel_ex2.pdf}
		\caption{Confronto Australia Bearman}
		\label{fig:confronto2}
	\end{wrapfigure}
	
	Infine, osservando la variabile \texttt{Tempo Giro}, alcuni piloti riportano alcuni valori \texttt{NA}. Osservando i dati\textsuperscript{\ref{appendice 2}}, ciò si verifica per i piloti Tsunoda, Bearman e Hadjar rispettivamente nei Gran premi di Emilia Romagna, Australia e Stati Uniti.
	
	
	Effettuando un'analisi di tipo qualitativo, si scopre che ciò è riconducibile ad un incidente durante il giro di qualifica. Le uniche telemetrie disponibili sono infatti riconducibili al giro di riscaldamento delle gomme, come si nota nella figura \ref{fig:confronto2}. Al fine di eliminare rumore nell'analisi si rimuovono queste osservazioni.
	

	
	Sempre per quanto riguarda la variabile \texttt{tempo giro}, considerando il regolamento della \textbf{FIA} (\href{https://www.fia.com/sites/default/files/fia_2025_formula_1_sporting_regulations_-_issue_1_-_2024-07-31.pdf}{39.4.b.i ; PAG:47}), secondo il quale se un pilota supera il $107\%$ del tempo giro minore viene escluso dalle qualifiche, si uniforma il dataset. Incriminati risultano essere i piloti Hamilton, Tsunoda, Antonelli, Albon e Bortoleto nel Las Vegas Grand Prix e Stroll nel Dutch Grand Prix.
	
	Analizzando il contesto, si nota che a Las Vegas i tempi più elevati sono imputabili alle condizioni meteo avverse (pioggia intensa), seguite da un progressivo asciugamento della pista che ha avvantaggiato gli altri piloti. Nel caso di Stroll, invece, il dato si riferisce a al primo giro di lancio completo, poiché nel momento del giro di qualifica non è stato completato il giro per un incidente.
	
	Di conseguenza per eliminare il rumore, si elimina soltanto l'occorrenza di Stroll, poiché il giro non rappresenta il "migliore" ma solamente il quello di lancio.\\

	
	\subsubsection{Trasformazione e creazione di nuove variabili}
	Per quanto riguarda l'analisi della variabile di \texttt{accelerazione laterale}, viene trasformata tramite valore assoluto. Così da ottenere una misura dell'intensità complessiva (magnitudo)\footnote{Estratto codice R consultabile nell'appendice \ref{trattamento variabili}.\label{appendice_3}}.
	
	Inoltre, l'\texttt{accelerazione longitudinale} viene suddivisa\textsuperscript{\ref{appendice_3}} in:
	\begin{itemize}
		\item 	\texttt{Accelerazione}, che comprende tutti i valori positivi;
		\item 	\texttt{Decelerazione} che al contrario della precedente comprende, tutti i valori negativi; 
	
	\end{itemize}
	Successivamente viene applicato il valore assoluto e per le restanti variabili telemetriche si mantiene invece la forma originaria.
		
	Si creano per le variabili \texttt{velocità, acceleratore, decelerazione e accelerazioni}, nuove variabili di variazione percentuali\footnote{Estratto codice R consultabile nell'appendice \ref{creazione variabili}}, per catturare l'intensità di variazione delle variabili che aiutano a distinguere lo stile di guida dei piloti, nei vari istanti di tempo:
	
	\begin{itemize}[noitemsep, topsep=0pt]
		\item \texttt{\textbf{\_lag1}} : variazione percentuale rispetto all'osservazione precedente;
		\item \texttt{\textbf{\_lag5}} : variazione percentuale rispetto a cinque osservazioni precedenti;
	\end{itemize}
	che vengono calcolate come:
	\[\Delta=\dfrac{x_{t}-x_{t-k}}{x_{t-k}}\] 
	indicando con $x_t$ l'unità statistica al tempo $t$ e $k=\{1,5\}$ numero di lag, per le misure di accelerazione e decelerazione. Nel caso in cui $x_{t-k}=0$ e $x_t=0$ non si applica la formula e la variabile \_lag assume 0 di default, quando invece si osserva solamente $x_{t-k}=0$ si sostituisce con $x_{t-k}=0.01$ per riuscire a mantenere la validità del calcolo e continuità delle dinamiche telemetriche.
	
	
	\subsection{Statistiche riassuntive}
	Vengono calcolate delle statistiche descrittive\footnote{Estratto codice R consultabile nell'appendice \ref{codice statistiche riassuntive}.} al fine di valutare in che modo le variabili possano essere associate allo stile di guida, considerando separatamente ciascun Gran Premio e Pilota.
	
	Per le misure di accelerazione laterale, longitudinale, decelerazione e per gli input di frenata, accelerazione e velocità vengono calcolate media e deviazione standard.	
	
	
	Per le variabili di tipo \texttt{\_lag$k$} vengono calcolate medie e deviazioni standard distinguendo tra variazioni positive e negative, così da evidenziare eventuali asimmetrie nel comportamento dinamico del pilota.\\
	
	Una volta calcolate media e deviazione standard, è possibile combinare questi valori per ottenere il coefficiente di variazione (CV):
	\[CV=\dfrac{sd(x)}{mean(x)}\]
	che misura la variabilità relativa di una variabile rispetto alla sua media. L’impiego di tale coefficiente permette di ridurre l’influenza del setup della vettura, rendendo confrontabili tra loro variabili che, in valore assoluto, dipendono dalle regolazioni meccaniche e aerodinamiche.

	
		
	Si arriva cosi ad ottenere un dataset contenente 28 variabili, che forniscono informazione sullo stile di guida del pilota nella specifica gara.
	
	Infine, per rimuovere l'influenza del tracciato, si riscalano tutte le variabili nell'intervallo $[0,1]$.
	
	Si procede dunque con una analisi delle correlazioni per ridurre la dimensionalità, e comprendere quali siano le variabili più significative nel fornire l'informazione.
	
	\subsection{Analisi delle componenti principali}
	
	Al fine di limitare i fenomeni di multicollinearità ed eliminare il rumore, sono state eliminate le variabili fortemente correlate tra loro ($cor(x,y)>0.9$)\footnote{Estratto del codice R consultabile nell'appendice \ref{correlazioni}}. Questo processo di scrematura permette di ridurre la dimensionalità a 26 variabili.
	
	Nonostante tale riduzione, una dimensionalità pari a 26 risulta ancora essere  sia ai fini di interpretabilità che per costo computazionale per un Model Base Clustering.
	
	
	Si effettua dunque un analisi delle componenti principali (PCA) con l’obiettivo di ottenere un’ulteriore riduzione dimensionale.
	I risultati ottenuti tramite PCA\footnote{Estratto del codice R consultabile nell'appendice \ref{PCA}} mostrano come le prime 4 componenti spieghino più del $60\%$ della varianza, come illustrato in figura \ref{fig:pca}.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=.5\textwidth]{tel_pca.pdf}
		\caption{Varianza Spiegata Cumulata}
		\label{fig:pca}
	\end{figure}
	
	
	\subsubsection{Interpretazione delle componenti}
	Attraverso l'analisi dei pesi associati alle componenti (Figura \ref{fig:pesi}) le si interpretano:
	\begin{enumerate}
		\item \textbf{Prima componente}  : Separa stili stili di guida che hanno un'alta variabilità (molte correzioni) nell'erogazione della potenza da quelli che hanno un'alta variabilità nella fase di decelerazione. A valori elevati corrisponde a uno stile di guida caratterizzato da una trazione più "sporca" o reattiva, con continue correzioni sul pedale dell'acceleratore che si contrappone uno stile caratterizzato da una frenata molto modulata e dinamica, mantenendo però un'uscita di curva molto composta e lineare nell'erogazione del gas.
		
		\item \textbf{Seconda componente} : distungue stili di guida che lavorano di più in termini di velocità pura (avanti/dietro) contro chi ha maggiore di percorrenza (destra/sinistra). A valorio elevati corrisponde uno stile di guida a "V", dove il pilota punta tutto sulla frenata profonda e sulla ripartenza rapida, variando molto l'accelerazione longitudinale. Invece, per valori bassi contrappone uno stile di guida basato sulla velocità di percorrenza, che predilige la gestione del carico laterale.
		
		\item \textbf{Terza componente} : questa componente entra nel dettaglio delle fasi della curva. Discrimina stili di guida con bassa componente laterale in fase di percorrenza e alta componente di accellerazioni longitudinali e viceversa. In particolare, a valori alti corrisponde uno stile di guida caratterizzato forti staccate, forti accellerazioni in uscita curva e bassa velocità di percorrenza. Mentre a valori bassi corrisponde uno stile caratterizzato alte velocità di percorrenza, e poca variazione longitudinale.
		
		\item \textbf{Quarta componente} :  questa componente caratterizza la configurazione della pista. A valori elevati corrisponde una maggiore variabilità complessiva della velocità, mentre valori bassi indicano un'andamento più regolare e uniforme.
		
	\end{enumerate}
		
	\textbf{N.B.} Il circuito vincola il pilota a modificare il proprio stile di guida alla configurazione del tracciato, alternando fluidità e aggressività in base alle specifiche richieste aerodinamiche o meccaniche. Tale adattamento serve quindi esclusivamente a ottimizzare lo sfruttamento della massima aderenza disponibile in ogni circuito.
	
	\begin{figure}[H]
		\centering
		\includegraphics[width=.6\textwidth]{Loadings.pdf}
		\caption{Pesi componenti}
		\label{fig:pesi}
	\end{figure}
	
	\section{Model Based Clustering}
	L'analisi di Clustering Model-Based, condotta sulle prime quattro componenti, ha permesso di identificare un modello \textit{VII} (\textit{Volume variabile}, \textit{forma sferica} e \textit{orientamento identico}) a tredici classi, con un totale di $77$ parametri stimati e $BIC$ pari a $-7108.435$.
	
	Il raggruppamento dei dati risulta già chiaramente distinguibile nella rappresentazione bidimensionale ottenuta dal confronto tra la prima e la seconda componente principale (Figura \ref{fig:12}), sebbene sia ancora presente una certa sovrapposizione visiva, interpretabile come “rumore” grafico. Tale effetto è attribuibile principalmente all’informazione contenuta nelle componenti principali rimanenti. Ciò è ulteriormente evidenziato dalla Figura \ref{fig:42}, in cui il confronto congiunto tra la quarta, la prima e la seconda componente consente di distinguere in modo più netto i cluster, migliorandone la separabilità rispetto alla rappresentazione bidimensionale.


	\begin{figure}[H]
		\centering
		\begin{subfigure}[b]{0.45\textwidth}
			\includegraphics[width=\textwidth]{C1_C2.pdf}
			\caption{Componente 1 VS Componente 2}
			\label{fig:12}
		\end{subfigure}
		\hfill
		\begin{subfigure}[b]{0.45\textwidth}
			\includegraphics[width=\textwidth]{newplot.png}
			\caption{Componente~1 VS~Componente~2 VS~Componente~4}
			\label{fig:42}
		\end{subfigure}
		\caption{Confronto clustering}
	\end{figure}
	
	Il valore della distanza di  Kullback-Leibler $(KL)$ del modello risulta essere pari a $ 89.622$. Ciò dà sostegno a quanto già osservato graficamente, ulteriormente supportato dall'incertezza pari a $0.0796$ che esclude una possibile situazione di sovrapposizione dei gruppi.
	
	\begin{table}[ht]
		\centering
		\begin{tabular}{|c|c|c|c|c|r|}
			\hline
			\textbf{Classe} & \textbf{COMP 1} & \textbf{COMP 2} & \textbf{COMP 3} & \textbf{COMP 4} & \textbf{GP}\\ 
			\hline
			1 & -2.3544521 & -0.4336353 & -0.3267068 & -1.04304992 & Australian, Abu Dhabi, Qatar,  Saudi, Spanish\\
			2 & -4.6485671 & -1.9013751 & 0.3596806 & 1.50701769 & Italian \\
			3 & -0.5809494 & -1.9670107 & 0.3270949 & -0.50006776 & Austrian, Emilia Romagna\\
			4 & 1.9782712 & 1.0854711 & -1.4384612 & 3.35259093 & Las Vegas\\
			5 & 3.3611817 & -0.7988630 & 0.3854497 & -0.58053173 & Mexico, Singapore\\
			6 & 1.6093561 & -2.9926369 & 3.1763503 & 1.47207130 & Azerbaijan\\
			7 & 0.6601369 & -1.8975598 & -1.5433976 & 0.33120784 & Canadian, Bahrain \\
			8 & -3.5929136 & 1.8655423 & 1.9612523 & 0.21243282 & Belgian\\
			9 & -1.7581531 & 3.1354654 & 0.7971459 & -0.15900006 & British, Japanese \\
			10 & 1.0999736 & 1.0575898 & -1.2098464 & 0.04385535 &United States, São Paulo, Chinese, Dutch\\
			11 & 2.5236924 & 1.0020324 & -0.4849935 & -1.88106300&  Hungarian, Dutch\\
			12 & -0.6392196 & 0.7454101 & 0.5008869 & 1.58845641 &  Miami\\
			13 & 5.8976535 & 0.5075088 & 1.8048374 & -0.47820303& Monaco\\
			\hline
		\end{tabular}
		\caption{Media delle Componenti Principali per Classe}
		\label{tab:pca_means}
	\end{table}
	\begin{itemize}
		\item Classe 13: Questa classe identifica uno stile  il Gran premio di Monaco. Il valore molto elevato della prima componente infatti si può associare ad un uso del gas ritmico. 
		
		\item Classi 5 e 11: (Singapore, Messico, Ungheria) Queste classi raggruppano circuiti tortuosi ad alto carico. Condividono con Monaco la necessità di gestire l'acceleratore per gestire per esempio un uscita da una curva netta.
		
		\item La Classe 6: (Baku) Mostra un'alta terza componente: le curve a 90° costringono  correzioni veloci della accelerazione laterale.
		
		\item La Classe 4 e 12: (Las Vegas e Miami) Mostrano un'alta quarta componente: l'asfalto scivoloso a soprattutto a Las Vegas per la pioggia creano incertezza nel mantenere la velocità costante, costringendo a parzializzare il gas dove normalmente si andrebbe costanti.
		
		\item Classi 8 e 9: (Spa, Silverstone, Suzuka) Queste classi rappresentano i circuiti con prima componente fortemente negativa dovuta all'assenza di frenate decise. La seconda componente positiva distingue questi circuiti: indica che la variazione è dominata dalle forze longitudinali ad alta velocità.
		
		\item Classe 10: (Cina, USA, Brasile) Raggruppa circuiti completi dal punto di vista del tracciato : alternano tratti veloci a tratti tecnici. Non risulta esserci una componente con pesi notevoli.
		
		\item Classe 2 : (Monza): La prima componente molto negativa. È una pista caratterizzata da staccate profonde con un'uscita di trazione pulita, inoltre la quarta componente abbastanza alta, dovuta alle elevate variazioni di velocità.
		
		\item Classe 7 : (Bahrain e Canada):  Sono circuiti caratterizzate da poche curve di alta velocità di percorrenza, evidenziato dal valore negativo della seconda componente.
		
		\item Classe 1 : (Australian, Abu Dhabi, Qatar,  Saudi, Spanish) È il gruppo più numeroso, caratteizzato da una prima componente negativa, quindi poche variazioni longitudinali e in generale fluidità nella percorrenza.
		
		\item Classe 3 : (Austrian, Emilia Romagna) Molto simile alla classe 1, ma con curve più accentuate e maggiori variazioni longitudinali.
	\end{itemize}
	
	\section{Classificazione}
	
	
	
	\clearpage
	\appendix
	\title{Appendice}
	\section{Codice R Commentato Estrazione dei dati}
	\label{estrazione}
	\begin{lstlisting}
		library(jsonlite)
		library(tidyverse)
		library(dotenv)
		
		rm(list=ls())
		
		json_path <- Sys.getenv("JSON_PATH")
		cartella <- json_path
		
		file_giri <- list.files(path = cartella, 
		pattern = "laptimes\\.json$", 
		full.names = TRUE, 
		recursive = TRUE)
		
		files_qualifiche_lap <- file_giri[grepl("Qualifying", file_giri) & !grepl("Sprint",file_giri)]
		lista_dati <- list()
		
		for(i in 1:length(files_qualifiche_lap)) {
			
			cartella_giro <- files_qualifiche_lap[i]
			
			laptimes_data <- fromJSON(cartella_giro)
			
			#Selezione giro migliore
			giro <- as.numeric(laptimes_data$lap[which.min(laptimes_data$time)])
			
			cartella_pilota <- dirname(cartella_giro)
			if(length(giro) > 0){
				path_telemetry <- paste0(cartella_pilota, "/", giro, "_tel.json")
			} else{
				giro <- 1
				path_telemetry <- paste0(cartella_pilota, "/", giro, "_tel.json") } 
			
			testo <- read_file(path_telemetry)
			testo <- str_replace_all(testo, "NaN", "null")
			json_data <- fromJSON(testo)[["tel"]]
			json_data <- as_tibble(json_data)
			
			parti_cartella <- str_split(cartella_giro, "/")[[1]]
			n <- length(parti_cartella)
			
			json_data$pilota <- parti_cartella[n-1]
			json_data$GP <- parti_cartella[n-3]
			json_data$lap_time <- rep(laptimes_data$time[giro],nrow(json_data))
			lista_dati[[i]] <- json_data
		}
		
		dataset_completo <- bind_rows(lista_dati)
		
		dataset_completo <- dataset_completo %>%
		select(-dataKey)
		
		setwd("C:/Users/feder/Documents/datasets/Computazionale/F1/data")
		saveRDS(dataset_completo, file = "dataset_completo_best_tel.rds")
	
	\end{lstlisting}

	\section{Codice R Commentato Esplorazione iniziale}
	\label{codice preliminare}
	\begin{lstlisting}
		# A seguito del caricamento delle librerie e del dataset si inizia l'esplorazione con le iniziali statistiche descrittive 
		summary(tel)
		# Sistemazione delle variabili
		tel$throttle <- ifelse(tel$throttle > 100, 100, tel$throttle)
	
		#Trattamento degli NA e None
	
		tel[which(is.na(tel$rel_distance)),]
		tel <- tel %>% filter(!(pilota == "RUS" & GP == "Miami Grand Prix"))
		
		
		
		#Rimozione NA di lap_time
				
		tel %>% 
		group_by(GP, pilota) %>% 
		filter(is.na(lap_time)) %>% 
		summarize(n = n(), .groups = "drop")
		
		tel <- tel %>% filter(!is.na(lap_time))
		
		#Applicazione regola 107 %
		
		tel %>% group_by(GP) %>% filter(lap_time > 1.07*min(lap_time))
		
		tel <- tel %>% filter(!(pilota=="STR" & GP=="Dutch Grand Prix"))
		
		
	
	\end{lstlisting}
	\section{Codice R Commentato Trattemento variabili}
	\label{trattamento variabili}
	\begin{lstlisting}
	tel.guida <- tel %>%  
	group_by(GP,pilota) %>% 
	mutate(
	dec_x = if_else(acc_x < 0, abs(acc_x), 0),
	acc_x = if_else(acc_x > 0, acc_x, 0),
	acc_y = abs(acc_y)) %>% 
	ungroup()
	\end{lstlisting}
	\section{Codice R Commentato Creazione variabili}
	\label{creazione variabili}
	\begin{lstlisting}
		#Variabili lag creazione 
		
		tel.guida <- tel.guida %>%
		
		select(GP,pilota,throttle,acc_x,acc_y,dec_x,brake,speed,rel_distance) %>% 
		
		arrange(GP,pilota,rel_distance) %>%
		
		group_by(GP,pilota) %>%
		
		mutate(
		across(
		c(throttle, acc_x, acc_y,dec_x,speed),
		list(
		
		lag1 = ~round(
		ifelse(
		lag(.x, 1) == 0 & .x == 0,
		0,
		ifelse(
		lag(.x, 1) == 0,
		(.x-0.01)/0.01,
		(.x - lag(.x, 1)) / lag(.x, 1))
		),
		4
		),
		
		lag5 = ~round(
		ifelse(
		lag(.x, 5) == 0 & .x == 0,
		0,
		ifelse(
		lag(.x, 5) == 0,
		(.x-0.01)/0.01,
		(.x - lag(.x, 5)) / lag(.x, 5))
		),
		4
		)
		
		),
		.names = "{.col}_{.fn}"
		)
		)  %>%  
		ungroup() %>% 
		select(-rel_distance)
	\end{lstlisting}
	\section{Codice R Commentato Statistiche Riassuntive}
	\label{codice statistiche riassuntive}
	\begin{lstlisting}
		#Statistiche descrittive 
		tel.guida_summary <- tel.guida %>% 
		group_by(GP, pilota) %>%
		{
			lag_cols <- names(.) %>% .[str_detect(., "lag")]
			
			summarise(.,
			across(
			c(throttle, acc_x, acc_y,dec_x,brake,speed), 
			list(
			mean = ~round(mean(.x, na.rm = TRUE), 4),
			sd = ~round(sd(.x, na.rm = TRUE), 4)
			),
			.names = "{.col}_{.fn}"
			),
			#Divisione lag positivi e negativi
			across(
			all_of(lag_cols),
			~round(mean(.x[.x > 0], na.rm = TRUE), 4),
			.names = "{.col}_mean_pos"
			),
			
			across(
			all_of(lag_cols),
			~round(mean(.x[.x <= 0], na.rm = TRUE), 4),
			.names = "{.col}_mean_neg"
			),
			
			across(
			all_of(lag_cols),
			~round(sd(.x[.x > 0], na.rm = TRUE), 4),
			.names = "{.col}_sd_pos"
			),
			
			across(
			all_of(lag_cols),
			~round(sd(.x[.x <= 0], na.rm = TRUE), 4),
			.names = "{.col}_sd_neg"
			),
			
			.groups = "drop"
			)
		}
		tel2 <- tel %>% 
				group_by(GP,pilota) %>% 
						summarize(laptime=max(lap_time)),.groups = "drop") 
		tel.guida_summary$laptime <- as.numeric(tel2$laptime)
	\end{lstlisting}
	
	\section{Codice R Commentato Creazione Coefficienti di Variazione}
	\label{CV}
	\begin{lstlisting}
		#Divisione variabili in medie e varianze 
		
		sd_cols <-tel.guida_summary %>% names(.) %>% .[str_detect(., "sd")]
		mean_cols <-tel.guida_summary %>%  names(.) %>% .[str_detect(., "mean")]
		
		tel.guida_summary.idx <- tel.guida_summary[sd_cols] / tel.guida_summary[mean_cols]
		
		names(tel.guida_summary.idx) <- str_replace(names(tel.guida_summary.idx), "sd", "CV")
		
		tel.guida_summary.idx$GP <- tel.guida_summary$GP                                          
		
		tel.guida_summary.idx$pilota <- tel.guida_summary$pilota   
	\end{lstlisting}
	\section{Codice R Commentato Analisi delle correlazioni}
	\label{correlazioni}
	\begin{lstlisting}
	
	tel.guida_summary.idx <- tel.guida_summary.idx %>% 
	
				mutate(across(where(is.numeric),~rescale(.,to=c(0,1))))
		
		
	corr <- round(cor(tel.guida_summary.idx %>% select(where(is.numeric))),4)
	
	#Ricerca di variabili dipendenti
	
	variabili_dipendenti <- findCorrelation(corr, cutoff = 0.9, names = TRUE, exact = T,verbose = T)
	
	tel.pca <- tel.guida_summary %>% 
				select(-all_of(variabili_dipendenti))
	
	\end{lstlisting}
	\section{Codice R Commentato Analisi delle componenti principali}
	\label{PCA}
	\begin{lstlisting}
	PCA <- princomp(tel.pca %>%
	select(where(is.numeric)),cor=T)
		
		
	summary(PCA)
	
	print(PCA$loadings,cutoff = 0)
	
	tel.comp <- as_tibble(PCA$scores[,1:4])
	
	\end{lstlisting}
	\section{Codice R Commentato Model Base Clustering}
	\begin{lstlisting}
		#Clustering
		
		clust <- Mclust(tel.comp,G=1:15)
		
		summary(clust)
		
		plot(clust, what="classification")
		
		plot(clust, what="uncertainty")
		
		plot(clust, what = "BIC", legendArgs = list(x = "bottomleft"))
		
		clust$BIC
		
		#Metriche di valutazione 
		KL <- round(abs(clust$icl - clust$bic),3); KL
				
		round(mean(clust$uncertainty),4)
		
		tel.comp.labels <- tel.comp
		
		tel.comp.labels$class <- as.factor(clust$classification)
		
		tel.comp.labels$pilota <- tel.pca$pilota
		
		tel.comp.labels$GP <- tel.pca$GP
		
		tel.comp.labels$laptime <- tel2$laptime
		
		tel.comp.labels <- tel.comp.labels %>% 
									arrange(laptime,GP,pilota)
		
		
				
		
		
		
		#Interpretazione delle classi
		
		summary <- tel.comp.labels %>%
						group_by(class) %>%
							summarize(
							across(where(is.numeric),
							list(
							mean = ~mean(.x, na.rm=T)
							)), .groups = "drop")
		
		table(tel.comp.labels$GP,tel.comp.labels$class)
		
	\end{lstlisting}
	\section{Codice R Commentato Classificazione}
	\label{classificazione}
	\begin{lstlisting}
		#Classificazione
		
		
		center_2025 <- PCA$center
		sd_2025 <- PCA$scale
		
		tel.pca24 <- scale(tel.pca24 %>% select(where(is.numeric)),center = center_2025,scale = sd_2025)
		
		test_set <- as_tibble(tel.pca24 %*% PCA$loadings)[,1:4]
		
		
		test_set$GP <- tel24$GP 
		test_set$pilota <- tel24$pilota
		test_set$label <- ifelse(test_set$GP == "Monaco Grand Prix", 13,
		ifelse(test_set$GP == "Italian Grand Prix", 8, 2))
		test_set <- test_set %>% 
		filter(GP == "Monaco Grand Prix"| GP== "Italian Grand Prix"| GP == "Azerbaijan Grand Prix")
		
		listmod=c("Gaussian_pk_L_I","Gaussian_pk_Lk_I","Gaussian_pk_L_B","Gaussian_pk_Lk_B","Gaussian_pk_L_Bk",
		"Gaussian_pk_Lk_Bk","Gaussian_pk_L_C","Gaussian_pk_Lk_C","Gaussian_pk_L_D_Ak_D","Gaussian_pk_Lk_D_Ak_D",
		"Gaussian_pk_L_Dk_A_Dk","Gaussian_pk_Lk_Dk_A_Dk","Gaussian_pk_L_Ck","Gaussian_pk_Lk_Ck")
		tel.data <- tel.comp
		tel.comp.labels$class <- as.factor(tel.comp.labels$class)
		tel.class <- unlist( tel.comp.labels[,5] )
		str(tel.class)
		str(tel.data)
		
		
		model <- list()
		set.seed(123)
		f=0
		n <- nrow(tel.data)
		for (i in sample(1:100000,2000,replace = F)){
			f <- f+1
			set.seed(i)
			for (c in c(10,15,30,40,50)){
				test.set.labels<-sample(1:n,c)
				res <-  mixmodLearn(tel.data[-test.set.labels,], tel.class[-test.set.labels], 
				models=mixmodGaussianModel(listModels=listmod,equal.proportions=T),criterion= "CV")
				model[[as.character(i)]]$Model <- res@bestResult@model
				model[[as.character(i)]]$CV <-    res@bestResult@criterionValue
				model[[as.character(i)]]$n <-    c
			}
			cat(paste("Progress ",f/200,"% \n"))
		}
		
		
		modell <- bind_rows(model)
		
		modell$Model <- as.factor(modell$Model)
		
		sort(table(modell$Model,modell$n),decreasing = T)
		
		res <-  mixmodLearn(tel.data[-test.set.labels,], tel.class[-test.set.labels], 
		models=mixmodGaussianModel(listModels="Gaussian_pk_Lk_B" ,equal.proportions=T),criterion= "CV")
		
		
		summary(res)
		
		
		
		pred <-  mixmodPredict(test_set %>% select(Comp.1,Comp.2,Comp.3,Comp.4), classificationRule=res@bestResult)
		
		test_set$class <- pred@partition
		
		mean(test_set$label!= test_set$class)
	\end{lstlisting}
\end{document}