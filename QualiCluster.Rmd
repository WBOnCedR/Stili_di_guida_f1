---
title: "QualiCluster"
author: "Pietro Riva, Federico Maccianti"
date: "2025-12-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Working set up

```{r}
rm(list=ls())
setwd("~/datasets/Computazionale/F1")
options(warn = -1) 

library(tidyverse)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(scales)
library(ggcorrplot)
library(mclust)
library(caret)
library(factoextra)
library(GGally)

```

# F1 : Telemetrie qualifiche

Il seguente studio si pone l'obiettivo di individuare dei possibili stili di guida attraverso il clustering model based.

## Esplorazione del dataset

Si va ora ad esplorare il dataset in maniera tale da poter capire quali variabili possano essere indicative per individuare uno **stile di guida** per ciascun pilota.

```{r}
tel <- readRDS("~/datasets/Computazionale/F1/data/dataset_completo_best_tel.rds")
head(tel)
tel <- as_tibble(tel)


tel %>% group_by(GP,pilota) %>% summarize(n())
```

```{r}
str(tel)
```

Le variabili presenti per ciascuna telemetria sono :

-   GP, pilota : Identificativi gara e pilota
-   time : Tempo dal via [s]
-   distance : Distanza percorsa [m]
-   rel_distance : Distanza normalizzata [0-1]
-   rpm : Giri motore [rpm]
-   speed : Velocità [km/h]
-   gear : Marcia [1-8]
-   throttle : Acceleratore [0-100%]
-   brake : Freno [0/1]
-   drs : DRS attivo [0/1]
-   acc_x : G longitudinale (+ accel, - freno)
-   acc_y : G laterale (+ destra, - sinistra)/
-   acc_z : G verticale
-   x, y, z : Coordinate spaziali [m]

Anzi tutto per ricercare un potenziale stile di guida bisogna individuare, a partire da queste variabili grezze, quelle che sono, in primo luogo, concettualmente legate al concetto di stile di guida. Con questo si fa riferimento a variabili quali:

-   throttle : utilizzo dell'accelleratore (brusco,graduale,intervallato, ...)
-   acc_x : tipologie di frenate (prevalentemente brusche/secche, più gestite, ...)
-   acc_y : tipologia di guida (accellerazioni in generale molto polarizzate potrebbero indicare una guida molto nervosa per esempio ...)

Le variabili posizionali

-   time
-   rel_distance
-   x, y, z

possono tornare utili per dare un riferimento alle rilevazioni.

Di seguito alcune analisi grafiche per supportare quanto appena affermato.

```{r}
tel.ex <- tel %>% filter(GP == "United States Grand Prix" & (pilota == "VER" |pilota == "LEC"|pilota== "NOR"))
colori_team <- c("VER" = "#0600EF", "LEC" = "#EF1A2D", "NOR" = "#FF8700")



tel_g <- tel.ex %>%
  select(rel_distance, pilota, acc_y, acc_x) %>%
  pivot_longer(cols = c(acc_y, acc_x), 
               names_to = "variabile", 
               values_to = "valore") %>%
  mutate(variabile = factor(variabile, 
                            levels = c("acc_y", "acc_x"),
                            labels = c(" Accelerazione Laterale (g)", " Accelerazione Longitudinale (g)")))


pp <- ggplot(tel_g, aes(x = rel_distance, y = valore, color = pilota)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.4) +
  geom_line(size = 0.6, alpha = 0.8) +
  facet_grid(variabile ~ ., scales = "free_y", switch = "y") + 
  scale_color_manual(values = colori_team) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Distanza Relativa",
    y = NULL,
    color = "Pilota"
  ) +
  theme(
    strip.placement = "outside", 
    strip.text.y = element_text(face = "bold", size = 7),
    strip.background = element_rect(fill = "gray96", color = NA),
    legend.position = "top",
    panel.spacing = unit(1.2, "lines"),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 16, margin = margin(b = 5)),
    plot.subtitle = element_text(size = 11, color = "gray30", margin = margin(b = 15))
  )

print(pp)


#ggsave("tel_ex1.pdf", pp, width = 7, height = 5, device = cairo_pdf)
```

```{r}
summary(tel)
```

Notando che il massimo che assume la variabile *throttle* è 104 si riporta tutto sulla scala originaria tenendo come massimo 100

```{r}
tel$throttle <- ifelse(tel$throttle > 100, 100, tel$throttle)
```

Inoltre si verificano delle osservazioni `NA` analizzando il dataset originale si nota come siano costanti le distanze e molti record pari a zero di conseguenza si presuppone che i sensori di telemetria abbiano avuto un'avaria si decide quindi di eliminare i dati relativi al GP di Miami di Russell

```{r}
tel[which(is.na(tel$rel_distance)),]


tel <- tel %>% filter(pilota != "RUS" & GP != "Miami Grand Prix")
```

Un ultimo accorgimento riguarda la variabile laptime essa infatti quando è pari a None il che si verifica per i piloti Tsunoda, Bearman e Hadjar rispettivamente nei GP Emilia romagna, Australian e Usa. Il motivo è perchè non hanno terminato il giro di qualifica quindi non c'è un tempo di giro ma comunque si è registrata la telemetria. Al fine di eliminare rumore nell'analisi si rimuovono queste osservazioni.

```{r}
tel.ex <- tel %>% filter(GP == "Emilia Romagna Grand Prix" & (pilota == "ANT" |pilota == "HAM"|pilota== "TSU"))
colori_team <- c("ANT" = "#0600EF", "HAM" = "#EF1A2D", "TSU" = "#FDD900")



tel_g <- tel.ex %>%
  select(rel_distance, pilota, acc_y, acc_x) %>%
  pivot_longer(cols = c(acc_y, acc_x), 
               names_to = "variabile", 
               values_to = "valore") %>%
  mutate(variabile = factor(variabile, 
                            levels = c("acc_y", "acc_x"),
                            labels = c(" Accelerazione Laterale (g)", " Accelerazione Longitudinale (g)")))


pp <- ggplot(tel_g
             , aes(x = rel_distance, y = valore, color = pilota)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray70", linewidth = 0.4) +
  geom_line(size = 0.6, alpha = 0.8) +
  facet_grid(variabile ~ ., scales = "free_y", switch = "y") + 
  scale_color_manual(values = colori_team) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Distanza Relativa",
    y = NULL,
    color = "Pilota"
  ) +
  theme(
    strip.placement = "outside", 
    strip.text.y = element_text(face = "bold", size = 7),
    strip.background = element_rect(fill = "gray96", color = NA),
    legend.position = "top",
    panel.spacing = unit(1.2, "lines"),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 16, margin = margin(b = 5)),
    plot.subtitle = element_text(size = 11, color = "gray30", margin = margin(b = 15))
  )

print(pp)


ggsave("tel_ex2.pdf", pp, width = 7, height = 5, device = cairo_pdf)
```

```{r}
tel %>% 
  group_by(GP,pilota) %>% 
  filter(lap_time == "None") %>% summarize(n(),lap_time=max(lap_time))

tel <- tel %>% filter(lap_time !="None")

```

## Feature engineering

Lo studio si pone di individuare stili di guida generali, non specifici di un circuito. Affinchè circuiti con molti rettilinei e circuiti con molte curve e nervosi siano conforntabili, si riscalano le accellerazioni, sia frontali che laterali, su un scala standard $[-1,1]$

```{r}
tel.guida <- tel %>%  
                group_by(GP,pilota) %>% 
                  mutate(
                   dec_x = if_else(acc_x < 0, abs(acc_x), 0),
                   acc_x = if_else(acc_x > 0, acc_x, 0)) %>% 
                    mutate(acc_x=rescale(acc_x,to=c(0,1)),dec_x=rescale(dec_x,to=c(0,1),acc_y= abs(rescale(acc_y,to = c(-1, 1))))) %>%                     ungroup()

```

Si creano le seguenti variabili:

-   **lag1**
-   **lag3**
-   **lag5**

Per calcolare la variazione percentuale delle variabili *throttle*,*acc_x*,*acc_y*,*dec_x* che da un indicazione della magnitudo delle variazioni durante il giro.

```{r}
tel.guida <- tel.guida %>%
  
  select(GP,pilota,throttle,acc_x,acc_y,dec_x,rel_distance) %>% 
  
  arrange(GP,pilota,rel_distance) %>%
  
  group_by(GP,pilota) %>%
  
  mutate(
    across(
      c(throttle, acc_x, acc_y,dec_x),
      list(
        
      lag1 = ~round(
  ifelse(
    lag(.x, 1) == 0 & .x == 0,
    0,
    ifelse(
      lag(.x, 1) == 0,
          (.x-0.01)/0.01,
           (.x - lag(.x, 1)) / lag(.x, 1))
  ),
  4
),

lag3 = ~round(
  ifelse(
    lag(.x, 3) == 0 & .x == 0,
    0,
    ifelse(
      lag(.x, 3) == 0,
          (.x-0.01)/0.01,
           (.x - lag(.x, 3)) / lag(.x, 3))
  ),
  4
),

lag5 = ~round(
  ifelse(
    lag(.x, 5) == 0 & .x == 0,
    0,
    ifelse(
      lag(.x, 5) == 0,
          (.x-0.01)/0.01,
           (.x - lag(.x, 5)) / lag(.x, 5))
  ),
  4
)

      ),
      .names = "{.col}_{.fn}"
    )
  )  %>% 
  ungroup() %>% 
  select(-rel_distance)
```

Si raccolgono ora le prime statistiche riassuntive delle variabili per valutare in che modo si possano definire delle variabili associate a un potenziale stile di guida, in particolare :

Per le variabili *throttle* ,*acc_x*, *acc_y*

-   Media;
-   Deviazione standard;

```{r}
tel.guida_summary <- tel.guida %>% 
  group_by(GP, pilota) %>%
  {
    lag_cols <- names(.) %>% .[str_detect(., "lag")]
    
    summarise(.,
      across(
        c(throttle, acc_x, acc_y,dec_x), 
        list(
          mean = ~round(mean(.x, na.rm = TRUE), 4),
          sd = ~round(sd(.x, na.rm = TRUE), 4)
        ),
        .names = "{.col}_{.fn}"
      ),
    
      across(
        all_of(lag_cols),
        ~round(mean(.x[.x > 0], na.rm = TRUE), 4),
        .names = "{.col}_mean_pos"
      ),
      
      across(
        all_of(lag_cols),
        ~round(mean(.x[.x <= 0], na.rm = TRUE), 4),
        .names = "{.col}_mean_neg"
      ),
      
      across(
        all_of(lag_cols),
        ~round(sd(.x[.x > 0], na.rm = TRUE), 4),
        .names = "{.col}_sd_pos"
      ),
      
      across(
        all_of(lag_cols),
        ~round(sd(.x[.x <= 0], na.rm = TRUE), 4),
        .names = "{.col}_sd_neg"
      ),
      
      .groups = "drop"
    )
  }
```

### PCA

Si valutano anzitutto le correlazioni tra le variabili per evitare problemi di multicollinearità.

```{r}
corr <- round(cor(tel.guida_summary %>% select(where(is.numeric))),4)

variabili_dipendenti <- findCorrelation(corr, cutoff = 0.9, names = TRUE, exact = T,verbose = T)

 print(variabili_dipendenti)
```

Filtraggio per variabili significative e standardizzazione per gara

```{r}

tel.pca <- tel.guida_summary %>% select(-all_of(variabili_dipendenti)) %>% group_by(GP) %>%
  mutate(across(where(is.numeric), ~ scale(.) )) %>% 
  ungroup()
```

throttle_sd: Variabilità nell'uso dell'acceleratore.

acc_x_mean: Media dell'accelerazione longitudinale positiva.

acc_x_sd: Variabilità della fase di accelerazione.

acc_y_mean: Media della forza G laterale.

acc_y_sd: Variabilità della forza laterale .

throttle_lag5_mean_pos: Accelerazione media del movimento del piede mentre preme il gas (quanto rapidamente aumenta la velocità di pressione).

acc_x_lag1_mean_neg: Velocità media con cui diminuisce l'accelerazione longitudinale (la fase di rilascio della spinta prima della frenata).

acc_y_lag1_mean_neg: Velocità media con cui diminuisce la forza laterale (velocità di raddrizzamento dello sterzo in uscita curva).

throttle_lag1_sd_pos: Inconsistenza nella velocità di pressione dell'acceleratore (se alta pilota più aggressivo se bassa pilota più preciso).

acc_x_lag3_sd_pos: variabilità di comportamento in uscita curva in base al tipo di curva

acc_y_lag5_sd_pos: variabilità nell'accelerazione laterale nell'inserimento in curva (se alta pilota più inconsistente ad entrare in curva se bassa pilota più fluido/aggressivo nell'ingresso).

acc_x_lag1_sd_neg: variabilità nella velocità di rilascio dell'accelerazione.

acc_x_lag3_sd_neg: variabilità durante il calo di accelerazione di durata maggiore.

acc_y_lag3_sd_neg: variabilità nell'accelerazione laterale nell'uscita da una curva (se alta pilota inconsistente ad uscire in curva se bassa pilota più fluido/aggressivo in uscita ).

dec_x_lag1_sd_pos: Consistenza nel rilascio del freno. Poiché dec_x è negativo, un cambiamento "positivo" significa tornare verso lo 0 (alzare il piede dal freno). Misura quanto è costante il pilota nel trail braking (frenata in curva).

dec_x_lag1_sd_neg: Consistenza nell'attacco del freno. Un cambiamento "negativo" significa andare verso valori più bassi (frenare più forte). Misura se il pilota "pesta" il freno sempre con la stessa decisione.

dec_x_lag3_sd_neg: Inconsistenza di ordine superiore (vibrazioni/micro-correzioni) durante la fase di attacco della frenata.

```{r}
PCA <- princomp(tel.pca %>%
                  select(where(is.numeric)),cor=T)
summary(PCA)
print(PCA$loadings,cutoff = 0)
tel.comp <- as_tibble(PCA$scores[,c(1:8)])
```


Vediamo quali sono le variabili che decrivono le prime quattro componenti.

```{r}
fviz_contrib(PCA, choice = "var", axes = 1, top = 15) 
fviz_contrib(PCA, choice = "var", axes = 2, top = 10)
fviz_contrib(PCA, choice = "var", axes = 3, top = 10)
fviz_contrib(PCA, choice = "var", axes = 4, top = 10)
fviz_contrib(PCA, choice = "var", axes = 5, top = 10)
fviz_contrib(PCA, choice = "var", axes = 6, top = 10)
fviz_contrib(PCA, choice = "var", axes = 7, top = 10)

```


```{r}
ggpairs(tel.comp,progress = F)
```





Si nota come la `PCA` abbia evidenziato nella prima componente le variabili con più peso riguardano l'accelerazione longitudinale e la variazione dell' accelerazioni l'ampia variazione di queste variabili potrebbe assimilarsi in una versione di guida più dinamica e aggressiva per quanto riguarda la seconda componente è l'accelerazione laterale insieme alle decelerazioni a fornire contributo, quindi per quanto riguarda lo stile di guida potrebbe riguardare dei piloti che entrano ed escono molto forti dalle curve molto aggressivi in curva. Per la terza componente invece dominano le variabili di accelerazione longitudinale insieme alle variabili riguardanti la pressione del pedale di accelerazione, in particolare potrebbero rappresentare il momento prima delle frenate\
Per la quarta componente invece predomina la pressione del piede sull'acceleratore, rappresentando come ogni pilota gestisca il pedale Riguardo alla quinta componente ci sono variabili rappresentanti l'uscita da una curva Per la sesta componente ci sono variabili rappresentanti l'entrata in una curva

```{r}
relevant <- c(
  "GP",
  "pilota",
  "throttle_sd",
  "acc_x_mean",
  "acc_x_sd",
  "acc_y_mean",
  "acc_y_sd",
  "throttle_lag2_mean_pos",
  "throttle_lag1_sd_pos",
  "acc_x_lag1_sd_neg",
  "acc_x_lag3_sd_pos",
  "acc_y_lag1_mean_neg",
  "acc_y_lag2_sd_pos",
  "dec_x_lag1_sd_neg",
  "acc_y_lag3_sd_neg",
  "acc_x_lag3_sd_neg",
  "acc_x_lag1_mean_neg",
  "dec_x_lag1_sd_neg"
  )

```

```{r}
tel.sum.pca <- as_tibble(round(PCA$scores[,c(1,2)],4))
tel.sum.pca <- tel.sum.pca %>%
  mutate(pilota = tel.guida_summary$pilota,
         GP = tel.guida_summary$GP)
```

```{r}

piloti_unici <- sort(unique(tel.sum.pca$pilota))


n_piloti <- length(piloti_unici)
colori_piloti <- setNames(
  c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00",
    "#FFFF33", "#A65628", "#F781BF", "#66C2A5", "#FC8D62",
    "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F", "#E5C494",
    "#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E")[1:length(piloti_unici)],
  piloti_unici
)


gp_list <- unique(tel.sum.pca$GP)

for (gp in gp_list) {
  
  dati_gp <- tel.sum.pca %>% filter(GP == gp)
  
  p <- ggplot(dati_gp, aes(x = Comp.1, y = Comp.2, color = pilota)) +
    geom_point(size = 5, alpha = 0.8) +
    geom_text(aes(label = pilota), hjust = -0.2, vjust = 0.5, size = 4, fontface = "bold") +
    scale_color_manual(values = colori_piloti) +
    labs(
      title = paste("Stile di Guida -", gp),
      x = "Magnitudo accellerazione laterale [G]",
      y = "Irruenza accelleraizione",
      color = "Pilota"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      legend.position = "right"
    )
  
  print(p)
}


```

## Clustering

```{r}
tel.clust <- tel.guida_summary %>%
  select(all_of(relevant))

```

```{r}
clust <- Mclust(tel.comp)
summary(clust)
plot(clust, what="classification")
plot(clust, what="uncertainty")
plot(clust, what = "BIC", legendArgs = list(x = "topright"))
clust$BIC

```

```{r}
tel.comp.labels <- tel.comp
tel.comp.labels["class"] <- clust$classification
```

```{r}
summary <- tel.comp.labels %>%
  group_by(class) %>%
  summarize(
    across(everything(),
    list(
      mean = ~mean(.x, na.rm=T)
  )), .groups = "drop"
  )
#write.csv(summary, "summary.csv")

tel.comp.labels$GP <- tel.pca$GP
tel.comp.labels$pilota <- tel.pca$pilota
tel2 <- tel %>% group_by(GP,pilota) %>% summarize(laptime=max(lap_time),life=max(life),strategy=(max(strategy)),gomma=(max(gomma))) %>% ungroup()
tel.comp.labels$laptime <- tel2$laptime
tel.comp.labels$life <- tel2$life
tel.comp.labels$strategy <- tel2$strategy
tel.comp.labels$gomma <- tel2$gomma

summary <- tel.comp.labels %>%
  group_by(pilota,class) %>%
  summarize(
    across(where(is.numeric),
    list(
      mean = ~mean(.x, na.rm=T)
  )),n() ,.groups = "drop"
  )
```

```{r}
gp_list <- unique(tel.clust$GP)

for (gp in gp_list) {
  
  dati_gp <- tel.clust %>% filter(GP == gp)
  
  p <- ggplot(dati_gp, aes(x = Comp.1, y = Comp.2, color = pilota)) +
    geom_point(size = 5, alpha = 0.8) +
    geom_text(aes(label = pilota), hjust = -0.2, vjust = 0.5, size = 4, fontface = "bold") +
    scale_color_manual(values = colori_piloti) +
    labs(
      title = paste("Stile di Guida -", gp),
      x = "Magnitudo accellerazione laterale [G]",
      y = "Irruenza accelleraizione",
      color = "Pilota"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      legend.position = "right"
    )
  
  print(p)
}
```

```{r}
tel.lap <- tel %>% group_by(GP,pilota) %>% summarize(laptime=max(lap_time))

tel.clust$laptime <- tel.lap$laptime

tel.clust <- tel.clust %>% arrange(laptime,GP,pilota,)
```
