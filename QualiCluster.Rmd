---
title: "QualiCluster"
author: "Pietro Riva"
date: "2025-12-30"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Working set up

```{r}
rm(list=ls())
setwd("C:/Users/feder/Documents/datasets/Computazionale/F1")
options(warn = -1) 

library(tidyverse)
library(ggplot2)
library(dplyr)
library(RColorBrewer)
library(scales)
library(ggcorrplot)
library(mclust)



```

# F1 : Telemetrie qualifiche

Il seguente studio si pone l'obiettivo di individuare dei possibili stili di guida attraverso il clustering model based.

## Esplorazione del Sdataset

Si va ora ad esplorare il dataset in maniera tale da poter capire quali variabili possano essere indicative per individuare uno **stile di guida** per ciascun pilota.

```{r}
tel <- readRDS("C:/Users/feder/Documents/datasets/Computazionale/F1/data/dataset_completo_best_tel.rds")
head(tel)
tel <- as_tibble(tel)
```

```{r}
str(tel)
```

Le variabili presenti per ciascuna telemetria sono :

-   GP, pilota : Identificativi gara e pilota
-   time : Tempo dal via [s]
-   distance : Distanza percorsa [m]
-   rel_distance : Distanza normalizzata [0-1]
-   rpm : Giri motore [rpm]
-   speed : Velocità [km/h]
-   gear : Marcia [1-8]
-   throttle : Acceleratore [0-100%]
-   brake : Freno [0/1]
-   drs : DRS attivo [0/1]
-   acc_x : G longitudinale (+ accel, - freno)
-   acc_y : G laterale (+ destra, - sinistra)/
-   acc_z : G verticale
-   x, y, z : Coordinate spaziali [m]

Anzi tutto per ricercare un potenziale stile di guida bisogna individuare, a partire da queste variabili grezze, quelle che sono, in primo luogo, concettualmente legato al concetto di stile di guida. Con questo si fa riferimento a variabili quali:

-   throttle : utilizzo dell'accelleratore (brusco,graduale,intervallato, ...)
-   brake : utilizzo del freno
-   acc_x : tipologie di frenate (prevalentemente brusche/secche, più gestite, ...)
-   acc_y : tipologia di guida (accellerazioni in generale molto polarizzate potrebbero indicare una guida molto nervosa per esempio ...)

Le variabili posizionali quali

-   time
-   rel_distance
-   x, y, z

possono tornare utili per dare un riferimento alle rilevazioni.

grafici di esempio per verificare le assunzioni sulle variabili

```{r}
tel.ex <- tel %>% filter(GP == "United States Grand Prix" & (pilota == "VER" |pilota == "LEC"|pilota== "NOR"))
colori_team <- c("VER" = "#0600EF", "LEC" = "#EF1A2D", "NOR" = "#FF8700")



tel_long <- tel.ex %>%
  select(rel_distance, pilota, throttle, acc_y, acc_x) %>%
  pivot_longer(cols = c(throttle, acc_y, acc_x), 
               names_to = "variabile", 
               values_to = "valore") %>%
  mutate(variabile = factor(variabile, 
                            levels = c("throttle", "acc_y", "acc_x"),
                            labels = c("Accel(%)", " Accel.Lat. (g)", " Accel. Long. (g)")))


pp <- ggplot(tel_long, aes(x = rel_distance, y = valore, color = pilota)) +
  geom_hline(yintercept = 0, linetype = "dashed", color = "gray70", size = 0.4) +
  geom_line(size = 0.6, alpha = 0.8) +
  facet_grid(variabile ~ ., scales = "free_y", switch = "y") + 
  scale_color_manual(values = colori_team) +
  theme_minimal(base_size = 12) +
  labs(
    x = "Distanza Relativa",
    y = NULL,
    color = "Pilota"
  ) +
  theme(
    strip.placement = "outside", 
    strip.text.y = element_text(face = "bold", size = 7),
    strip.background = element_rect(fill = "gray96", color = NA),
    legend.position = "top",
    panel.spacing = unit(1.2, "lines"),
    panel.grid.minor = element_blank(),
    plot.title = element_text(face = "bold", size = 16, margin = margin(b = 5)),
    plot.subtitle = element_text(size = 11, color = "gray30", margin = margin(b = 15))
  )

print(pp)


ggsave("tel_ex1.pdf", pp, width = 7, height = 5, device = cairo_pdf)
```

Si riscalano le variabili di accelerazione al fine di peter equiparare i diversi tracciati tra loro

```{r}
tel.guida <- tel  %>% 
  group_by(GP) %>% 
  mutate(across(c(acc_x,acc_y), ~ abs(rescale(.,to = c(-1, 1))))) %>% 
  ungroup
```

Si creano le seguenti variabili:

-   **lag1**
-   **lag2**
-   **lag3**

Per calcolare la variazione percentuale delle variabili *throttle*,*acc_x*,*acc_y* che da un indicazione del.......

```{r}
tel.guida <- tel.guida %>%
  
  select(GP,pilota,throttle,brake,acc_x,acc_y,time) %>% 
  
  arrange(GP,pilota,time) %>%
  
  group_by(GP,pilota) %>%
  
  mutate(
    across(
      c(throttle, acc_x, acc_y),
      list(
        # La tilde (~) va all'inizio per dire "questa è una funzione"
        lag1 = ~round(ifelse(lag(.x, n = 1) == 0, (.x - 0.01) /0.01, (.x - lag(.x, n = 1)) / lag(.x, n = 1 )),4),
        lag2 = ~round( ifelse(lag(.x, n = 2) == 0, (.x - 0.01) /0.01, (.x - lag(.x, n = 2 )) / lag(.x, n = 2)),4),
        lag3 = ~round( ifelse(lag(.x, n = 3) == 0, (.x - 0.01) /0.01, (.x - lag(.x, n = 3 )) / lag(.x, n = 3 )),4)
      ),
      .names = "{.col}_{.fn}"
    )
  )  %>% 
  ungroup() %>% 
  select(-time)
```

Si raccolgono ora le prime statistiche riassuntive delle variabili per valutare in che modo si possano definire delle variabili associate a un potenziale stile di guida, in particolare :

-   Per le variabili *throttle* ,*acc_x*, *acc_y*, *brake*
-   Media;
-   Deviazione standard;
-   Massimo;
-   Minimo;

```{r}
tel.guida_summary <- tel.guida %>% 
  group_by(GP, pilota) %>%
  {
    lag_cols <- names(.) %>% .[str_detect(., "lag")]
    
    summarise(.,
      across(
        c(throttle, acc_x, acc_y, brake), 
        list(
          mean = ~round(mean(.x, na.rm = TRUE), 4),
          sd = ~round(sd(.x, na.rm = TRUE), 4),
          max = ~round(max(.x, na.rm = TRUE), 4),
          min = ~round(min(.x, na.rm = TRUE), 4)
        ),
        .names = "{.col}_{.fn}"
      ),
    
      across(
        all_of(lag_cols),
        ~round(mean(.x[.x > 0], na.rm = TRUE), 4),
        .names = "{.col}_mean_pos"
      ),
      
      across(
        all_of(lag_cols),
        ~round(mean(.x[.x <= 0], na.rm = TRUE), 4),
        .names = "{.col}_mean_neg"
      ),
      
      across(
        all_of(lag_cols),
        ~round(sd(.x[.x > 0], na.rm = TRUE), 4),
        .names = "{.col}_sd_pos"
      ),
      
      across(
        all_of(lag_cols),
        ~round(sd(.x[.x <= 0], na.rm = TRUE), 4),
        .names = "{.col}_sd_neg"
      ),
      
      .groups = "drop"
    )
  }
```

```{r}
colSums(is.na(tel.guida_summary))
```

```{r}
tel.guida_summary[!complete.cases(tel.guida_summary), ]
```

L'unico record che presenta degli `NaN` nelle statistiche riassuntive è Russel al *Miami Grand Prix*.

```{r}
tel.guida %>%
  filter((pilota == "RUS") & (GP == "Miami Grand Prix"))
```

Da questa tabella si può vedere che ci sono stati probabilmente dei problemi con i sensori di telemetria durante la qualifica. Si procede quindi a rimuovere il record. Si rimuovono inoltre le statistiche `brake_min` e `brake_max` in quanto trattandosi di una variabile dicotomica non sono per nulla indicative ed anche della variabile `throttle_min` e `throttle_max` in quanto limitata in [0-100] quindi risulterebbe costante per tutti i piloti.

```{r}
tel.guida <- tel.guida %>%
  filter((pilota != "RUS") & (GP != "Miami Grand Prix"))
tel.guida_summary <- tel.guida_summary %>%
  filter(complete.cases(.)) %>%
  select(-brake_max, -brake_min,-throttle_max,-throttle_min)
```

### PCA

```{r}
PCA <- princomp(tel.guida_summary %>%
                  select(where(is.numeric)),cor=T)
summary(PCA)
```

Vediamo quali sono le variabili che decrivono le prime due componenti.

```{r}
sort(round(PCA$loadings[,1],4),decreasing = T)
```

```{r}
sort(round(PCA$loadings[,2],4),decreasing = T)
```

```{r}
tel.sum.pca <- as.tibble(round(PCA$scores[,c(1,2)],4))
tel.sum.pca <- tel.sum.pca %>%
  mutate(pilota = tel.guida_summary$pilota,
         GP = tel.guida_summary$GP)
```

```{r}

piloti_unici <- sort(unique(tel.sum.pca$pilota))


n_piloti <- length(piloti_unici)
colori_piloti <- setNames(
  c("#E41A1C", "#377EB8", "#4DAF4A", "#984EA3", "#FF7F00",
    "#FFFF33", "#A65628", "#F781BF", "#66C2A5", "#FC8D62",
    "#8DA0CB", "#E78AC3", "#A6D854", "#FFD92F", "#E5C494",
    "#1B9E77", "#D95F02", "#7570B3", "#E7298A", "#66A61E")[1:length(piloti_unici)],
  piloti_unici
)


gp_list <- unique(tel.sum.pca$GP)

for (gp in gp_list) {
  
  dati_gp <- tel.sum.pca %>% filter(GP == gp)
  
  p <- ggplot(dati_gp, aes(x = Comp.1, y = Comp.2, color = pilota)) +
    geom_point(size = 5, alpha = 0.8) +
    geom_text(aes(label = pilota), hjust = -0.2, vjust = 0.5, size = 4, fontface = "bold") +
    scale_color_manual(values = colori_piloti) +
    labs(
      title = paste("Stile di Guida -", gp),
      x = "Magnitudo accellerazione laterale [G]",
      y = "Irruenza accelleraizione",
      color = "Pilota"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      legend.position = "right"
    )
  
  print(p)
}


```

## Clustering

```{r}
relevant <- c("GP", "pilota", "acc_y_lag3_sd_pos", "acc_y_lag2_sd_pos", "acc_y_lag1_sd_pos", 
              "acc_y_lag3_mean_pos", "acc_y_lag2_mean_pos", "acc_y_lag1_mean_pos",
              "throttle_lag3_sd_pos", "throttle_lag2_sd_pos", "throttle_lag1_sd_pos", 
              "throttle_lag3_mean_pos", "throttle_lag2_mean_pos", "throttle_lag1_mean_pos")

tel.clust <- tel.guida_summary %>%
  select(all_of(relevant)) %>%
  filter(
    if_all(where(is.numeric), ~between(.x, 
                                   quantile(.x, 0.25, na.rm = TRUE) - 1.5 * IQR(.x, na.rm = TRUE),
                                   quantile(.x, 0.75, na.rm = TRUE) + 1.5 * IQR(.x, na.rm = TRUE)))
  )

```

```{r}
clust <- Mclust(tel.clust %>% select(-GP, -pilota))
summary(clust)
plot(clust, what="classification")
plot(clust, what="uncertainty")
```

```{r}
tel.clust["class"] <- clust$classification
```

```{r}
summary <- tel.clust %>%
  select(-GP,-pilota)%>%
  group_by(class) %>%
  summarize(
    across(everything(),
    list(
      mean = ~mean(.x, na.rm=T)
  )), .groups = "drop"
  )
```

```{r}
gp_list <- unique(tel.clust$GP)

for (gp in gp_list) {
  
  dati_gp <- tel.clust %>% filter(GP == gp)
  
  p <- ggplot(dati_gp, aes(x = Comp.1, y = Comp.2, color = pilota)) +
    geom_point(size = 5, alpha = 0.8) +
    geom_text(aes(label = pilota), hjust = -0.2, vjust = 0.5, size = 4, fontface = "bold") +
    scale_color_manual(values = colori_piloti) +
    labs(
      title = paste("Stile di Guida -", gp),
      x = "Magnitudo accellerazione laterale [G]",
      y = "Irruenza accelleraizione",
      color = "Pilota"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(hjust = 0.5, face = "bold", size = 16),
      legend.position = "right"
    )
  
  print(p)
}
```
